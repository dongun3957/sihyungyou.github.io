---
layout: post
title: "운영체제 - instaGrapd"
tags: [OS, 공부, 한동대]
comments: true
---

> instaGrapd (auto code grading system)  

### What is instaGrapd?  
![Center example image](https://user-images.githubusercontent.com/35067611/60441394-d61cb380-9c51-11e9-8a81-6e434446b1f6.png "Center"){: .center-image}  

### Requirements  
* a student submits a C program source code file via the client program  
* the server builds and tests the given source code with given test cases  
* the server sends the result back to the student as feedback  

### Required skills
* process control (e.g., fork)
* signal handling  
* inter-process communication using pipe  
* socket programming  
* multithreaded programming  

### ./submitter -n <IP>:<Port> -u <ID> -k <PW> <File>  
First, it stores ip address, port number of instagrapd, user id and pwd, file to variables respectively using getopt and strtok functions. By socket programming, it connects to instagrapd and send user id, pwd, codes. Target c source file is opened here and the contents of file are stored in "codes" variable.  

At first connection to instagrapd, it sends info as ‘id-pwd-codes’ form. Since it’s better to send one message via TCP before shutdown, we designed to send user info as one string data. After the first connection, it frequently connects to instagrapd, waiting for the test result.  

~~~c
while(1) {

    sock_fd = socket(AF_INET, SOCK_STREAM, 0) ;
    if (sock_fd <= 0) {
        perror("socket failed : ") ;
        exit(EXIT_FAILURE) ;
    } 

    memset(&serv_addr, '0', sizeof(serv_addr)); 
    serv_addr.sin_family = AF_INET; 
    serv_addr.sin_port = htons(atoi(port));

    if (inet_pton(AF_INET, ip, &serv_addr.sin_addr) <= 0) {
        perror("inet_pton failed : ") ; 
        exit(EXIT_FAILURE) ;
    } 

    if (connect(sock_fd, (struct sockaddr *) &serv_addr, sizeof(serv_addr)) < 0) {
        perror("connect failed : ") ;
        exit(EXIT_FAILURE) ;
    }

    if (i == 0) {
        printf("new connection has been made\n");
        if( send(sock_fd, id, strlen(id), 0) < 0) {
            printf("id pass error\n");
        }
        printf("passed id : %s\n", id);
        sleep(1);
        i++;
    }

    if (i == 1) {
        if( send(sock_fd, pw, strlen(pw), 0) < 0) {
            printf("pw pass error\n");
        }
        printf("passed pw : %s\n", pw);
        sleep(1);
        i++;
    }
    if (i == 2) {
        while((fsize = fread(sdbuf, sizeof(char), 500, fs)) > 0) {
            printf("paased code : %s\n", sdbuf);
            if (send (sock_fd, sdbuf, fsize, 0) < 0) {
                printf("stderr!\n");
                break;
            }
            printf("> file %s from clinet was sent!\n", path);
        }
        sleep(1);
        i++;
        fclose(fs);
    }

    if (i > 2) {
        printf("waiting for feedback..\n");
        if ( send(sock_fd, pw, strlen(pw), 0) < 0) {
            printf("requesting error\n");
        }
        printf("requesting again.. pw : %s\n", pw);

        if ( s = recv(sock_fd, buf, 10, 0) > 0) {
            printf("recved feedback : %s\n", buf);
            if ( strcmp(buf, "correct") == 0) break;
            else continue;
        }
    }

    shutdown(sock_fd, SHUT_WR);
}
~~~

### ./instagrapd -p <Port> -w <IP>:<WPort> <Dir>  


[full code available here](https://github.com/sihyungyou/OperatingSystem/tree/master/pa2/instaGrap)  
### demo video
[instaGrapd demo](https://www.youtube.com/watch?v=SI6DPSGSaSU)
