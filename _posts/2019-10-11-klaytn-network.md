---
layout: post
title: "Klaytn 정복기 03 : 네트워크 구조"
tags: [해커톤, 블록체인, Klaytn]
comments: true
---

> Blcok Propagation, Klaytn Network  

### 블록생성싸이클  
블록생성주기를 round라고 한다. 각 round는 새 블록을 생성하고 끝나는 즉시 새로운 round가 시작 된다. 클레이튼의 블록생성간격은 1초정도임

제안자와 위원회의 선택이 어떻게 될까? 제안자를 무작위 & 결정적으로 governance council(합의노드들) 중 뽑는다. 각각의 합의노드가 가장 최근의 블록헤더에서 파생된 난수사용해서 자기가 라운드에 선택되었는지 증명한다(이 부분은 이해가 안간다..)  

### 블록제안과 검증  
자기가 제안자로 뽑혔다는 증거를 다른 합의노드들에게 알린다. 제안자의 공개키를 통해서 입증가능한 암호증명으로 증명한다. 그리고 해당 라운드의 위원회 노드로 뽑힌 노드들도 위원회에게 증거와 함께 자기가 뽑혔다고 증명하면서 알린다. 이 과정을 통해 제안자와 위원회가 파악이된다. 그러면 제안자가 블록을 만들고 합의를 하고 round가 마무리된다.  

### 블록전파  
제안된 블록은 성공적으로 완료되기 위해 위원회의 2/3이상의 서명을 받아야 한다. 합의에 이르게 되면 새로운 블록이 모든 합의 노드들에게 전달이 되고 이제 프록시 노드를 통해서 엔드포인트 노드들에게 전달이 된다. 

![Center example image](https://user-images.githubusercontent.com/35067611/66627298-2edaef80-ec36-11e9-95af-6692d9534641.png "Center"){: .center-image}  

### Klaytn 네트워크 구조  
![Center example image](https://user-images.githubusercontent.com/35067611/66627400-909b5980-ec36-11e9-9c6e-95eeb63276b5.png "Center"){: .center-image}  

용어  
- CN : Consensus Node  
- CNN : Consensus Node Network  

- PN : Proxy Node  
- PNN : Proxy Node Network  

- EN : Endpoint Node Network  
- ENN : Endpoint Node Network  

- Bootnode : 새 노드를 네트워크에 등록하고 다른 노드에 연결할수있도록 도움을 주는 클레이튼만의 특수운영 노드  

PN, EN 부트노드는 공개가 된다. PN Bootnode는 허용된 프록시노드만 등록하게 도와주고 EN과 연결할수있도록 도와준다. EN Bootnode는 어떤 PN에 연결해야할지 EN에게 정보를 제공한다.  

하나의 코어셀은 하나의 참여자가 운영을 하는데 하나의 시행과 그 CN과 그 CN과연결된 여러 PN로 운영이된다. 합의과정에서 서로 최대한 빨리 커뮤니케이션 해야하므로 이 CN들은 각자가 서로 소통할수있도록 서로 연결되어있다. 하지만 CN은 외부와 직접적으로 접근 불가하다. 방해 없는 매우 private한 노드들이기때문에 빨리 합의로 도달할수있는 장점이 있다.  

### 코어셀  
그럼 어떻게 운영되는가? 코어셀 참여자로써 자기가 운영하고 관리할수있는 PN을 내세운다. 바깥에 보면 EN들이 코어셀 안에 있는 PN과 연결되어있다. 이 연결을 통해 정보를 주고받는다. 물론 EN끼리 연결해서 정보를 주고받을수도 있지만 EN을 PN과 연결하면 더 빠르고 신속하게 더 신뢰도있는 블록을 받을 수 있다. EN이 되기위한 조건은 없다. 아무나 EN이 돼서 웹이나 모바일같은 클라이언트에게 정보를 제공할 수 있다. 하지만 코어셀에 들어가는 CN 참여조건은 다음과 같다.  

CN 참여조건  
- Physical core 40개 이상  
- 256 GB RAM  
- 1년치의 데이터 약 14TB 저장  
- 10G 네트워크  

위처럼 CN 참여조건은 상당히 까다롭고 진입장벽이 높다. 그 이유는 확장성측면을 다시 생각해보면 합당하다. 합의를 담당하는 코어셀에서는 메인넷이 결정되면 몇십대 정도로 운영이 될 것이다. 하지만 사용자가 많아지면 어떻게 해야할까? 이전 포스팅에서 언급했듯이 일반적으로 clinet가 늘어나면 server를 늘리고 request 분할한다. 하지만 블록체인 네트워크에서는 노드를 늘려봣자 늘린만큼 정보를 더 전달해야하기떄문에 성능이 늘어나는게아니다. 그래서 노드 개수를 늘리는게아니라 노드들 자체의 성능을 늘리는 것이다. 예를 들어 RAM, CPU의 성능을 더 높이는 것! 물론 하나의 성능이 높다고해서 코어셀 전체가 높아지는건 아니다. 바틀넥있는데 이것이 전체가 다 똑같이 스펙 향상이 필요한 이유다.  

클레이튼 구조는 하나의 CN에 여러 PN을 연결해 놓았다. CN은 연결에 필요한 자원이 제한적이고, CN자체도 수가 한정적이기 때문이. 그래서 EN까지의 연결을 PN을 통해서 하는 것이다.  
EN이 CN으로 바로 연결가능하다고 하자. EN 1000개까지 커넥션 감당가능하다면 그 이상이된다면 CN에게 상당한 부담일 것이다. 그러니까 PN을 둬서 그 역할을 대신 하는 것이다. EN과 연결해서 넘어온 TX를 CN에 넘겨주는 것. 그리고 CN은 PN 몇 대만 연결하면 되니까 부담이 덜 갈 것이다. 그리고 PN을 여럿 둠으로서 코어셀에 연결하려는 EN들을 도와줄 수 있다. 즉 CN은 합의를 담당하는 노드라서 커넥션으로 인해 성능에 걸림돌이 되어선 안되므로 PN이 CN을 보호한다. 그렇게 PN 여러대를 둠으로써 확장성 문제를 해결하는 것이다.  

출처 : [인프런 클레이튼 강의](https://www.inflearn.com/course/%ED%81%B4%EB%A0%88%EC%9D%B4%ED%8A%BC#)  