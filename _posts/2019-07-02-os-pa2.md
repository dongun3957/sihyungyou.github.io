---
layout: post
title: "운영체제 - instaGrapd"
tags: [OS, 공부, 한동대]
comments: true
---

> instaGrapd (auto code grading system)  

### What is instaGrapd?  
![Center example image](https://user-images.githubusercontent.com/35067611/60441394-d61cb380-9c51-11e9-8a81-6e434446b1f6.png "Center"){: .center-image}  

### Requirements  
* a student submits a C program source code file via the client program  
* the server builds and tests the given source code with given test cases  
* the server sends the result back to the student as feedback  

### Required skills
* process control (e.g., fork)
* signal handling  
* inter-process communication using pipe  
* socket programming  
* multithreaded programming  

### ./submitter -n [IP]:[Port] -u [ID] -k [PW] [File]  
First, it stores ip address, port number of instagrapd, user id and pwd, file to variables respectively using getopt and strtok functions. By socket programming, it connects to instagrapd and send user id, pwd, codes. Target c source file is opened here and the contents of file are stored in "codes" variable.  

At first connection to instagrapd, it sends info as ‘id-pwd-codes’ form. Since it’s better to send one message via TCP before shutdown, we designed to send user info as one string data. After the first connection, it frequently connects to instagrapd, waiting for the test result.  

### ./instagrapd -p [Port] -w [IP]:[WPort] [Dir]  
In main function, it first receives arguments(getopt) and store them in each different variables. Then, since it has directory path of ‘testcases’ , it iteratively opens *.in file and store each test input in ‘ins’ array variable.  Now, we used socket programming here to listen to submitter and whenever it accepts connection, it creates a thread and the thread goes to thread_proc function.  

In thread_proc function, it receives ‘id-pwd-codes’ from a submitter and store each info respectively in variables using strtok function. We used multithreaded programming here to deal with multiple submitters simultaneously.  

In instagrapd, we need to globally store the user id  and pwd so that whenever submitter requests connection, it should see if it’s new id or not. If not, it should see if the submitter has correct pwd based on the global variables(ids, pws,codes array that can hold up to 20 submitters). Since new processes(using fork) duplicate global variables as well which leads to wrong counting of submitters, we instead used new thread in order to globally keep user id and pwd in instagrapd. So, whenever it accepts connection with id, pwd info, it first iterates ids, pws array variables to see if there’s same info and if not, it newly stores them in variables. Only after storing new submitter information to array, it adds up the counting variable.  

Now it should connect to the worker. We used socket here to connect to worker and this part is in for loop repeating 10 times. At a time, it makes new connection to worker and sends a pair of codes and test input which is stored in ins variable. The form is codes|ins to send them as one string. After shutdown, it receives data from worker which should be test result.  
ㄹ
### ./worker -p [Port]  
First, the worker also parse the arguments which comes in form of -p [Port] which is for listening port for instagrapd. Once the connection between instagrapd is successfully made, it will fork the process from main. In child process, worker accepts the data from instagrapd in form of "codes|testinput" as a pair for ten times. Using strtok, properly slice the strings into codes part and testing input part. Extract the code as “output.c” file for gcc compile later, and testing input to “testcase.txt” for retrieving from file and use as standard input for compiled output.c. Now, using system() function which conducts fork and execl procedure to compile the output.c file.  

The main function of worker now starts, pipe redirection. First, create two pipes. Redirect standard input to textcase.txt file using dup2(pipes[0], 0).  After that, redirect standard output pipe to output.out using dup2(pipes[1], 1). Now when worker compile output.c file, it will accept standard input from reading testcase.txt, not keyboard. Also it will print standard output not to monitor but to output.out file.  

Finally worker simply reads output.out file and send back to instagrapd as the output of target C file. For now, worker works properly when submitted file generates no error in compile process. Considering the situation when it gives error message which is likely to happen most of the time, we must handle the standard error as well. Just like we used dup2() function to redirect standard input and output, we came up with same idea : redirecting the pipe from 2 (stderr) to output.out file as well.  

[instaGrapd demo](https://www.youtube.com/watch?v=SI6DPSGSaSU)  
[full code available here](https://github.com/sihyungyou/OperatingSystem/tree/master/pa2/instaGrap)  
