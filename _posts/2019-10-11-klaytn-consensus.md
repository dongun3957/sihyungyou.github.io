---
layout: post
title: "Klaytn 정복기 02 : 합의"
tags: [해커톤, 블록체인, Klaytn]
comments: true
---

> BFT -> IBFT  

### 합의알고리즘이란?  
블록체인 네트워크에서 새로 생성된 블록이 인정을 받고 기존의 체인에 연결되기까지 다른 블록들의 합의를 받아야하는데 그 과정에서 사용되는 알고리즘이다. 보통 public 블록체인 네트워크는 PoW, Pos 등의 알고리즘을, private 블록체인 네트워크에서는 pBFT, Raft 등을 사용한다.  

private 네트워크가 public보다 더 효율적으로 합의에 도달할 수 있는데 특히 BFT는 참여노드를 제한하여 효율과 성능을 높인다. 하지만 노드를 제한하면 분산화가 약화되고 합의 내용이 소규모 노드에게만 공개되기 때문에 투명성이 저하된다.  

그런데 클레이튼의 합의 알고리즘은 BFT의 성능이점을 살리되 public 블록체인의 장점과 결합한 IBFT를 선택해 안정성, 투명성, 보안성을 자랑한다. 공개를 통한 개인적인 합의 신뢰 모델 지향하는 것이다. 합의를 달성하는 소수의 private 노드 + 블록생성결과를 공개적으로 접근 및 검증하는 바깥 노드로 구성되어있다.  

### IBFT(Istanbul Byzantine Fault Tolerance)  
IBFT는 다음의 세 단계의 합의 과정으로 이루어져있다 : pre-prepare, prepare, commit  
![Center example image](https://user-images.githubusercontent.com/35067611/66626755-63e64280-ec34-11e9-938d-697f59202e7d.png "Center"){: .center-image}  

라운드 로빈 방식으로 매 라운드마다 합의 노드들 중에 프로포저를 뽑는다. 그리고 나머지 합의노드들은 validator가 된다. x표시된 validator 3 은 fault 한 상태로 검증자로써 작동을 못하는 상태이다 (네트워크 끊어지거나 컴퓨터 고장난 등)  

0. propose : 한 노드가 합의 노드로 선택  

1. pre-prepare : proposer 노드가 블록을만들어서 다른 노드들에게 제안을 하게 됨  

2. prepare : 검증자 노드들 (validator 1,2,3)이 메세지를 받으면 자신을 제외한 노드들에게 잘 받았다고 메세지를 보냄 (하지만 validator 3 노드는 아무것도 보내지 않음 fault니까 받기만 함) 이 과정을 거치면 총 시스템에서 몇개의 노드가 살아있는지 알 수 있다. 또한 모든 검증자들이 모두 같은 round에 있는지 확인한다.  

3. commit : proposer에게 받은 블록을 수락할 건지 다른 노드들과 소통하면서 결정. 예를 들어 괜찮다고 생각하는지, 잘못되었다고 생각하는지 서로 응답을 주고받음. 만약 2/3 이상이 합의했다고 계산되면 블록 승인하고 넘어감. 즉, commit 단계에서 결정이 되고 finality가 정리가 됨. 변경 불가한 최종상태가 이 stage에서 마무리가 되는 것 PoW처럼 애매한 상태가 아니라는 것  

IBFT의 장점은 합의노드들끼리 통신을 통해 합의를 이끌어 내고 그 즉시 완결성을 가지게 되는 데에 있다.
단점은 합의노드가 많아지면 통신량이 기하급수적으로 늘어난다. 이를 해결하기 위해 클레이튼은 합의노드의 일부만 뽑아서 BFT를 유지한다. 합의노드의 일부만 뽑는다면 BFT처럼 노드를 제한하는 것이 아닌가 싶겠으나 클레이튼의 [two layer network]는 단순히 제한하는 것이 아니라 네트워크의 구조에 다른 블록체인과 차별점을 둔다.  